<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<jsp:include page="../../inc.jsp"></jsp:include>
<c:set var="ctx" value="${pageContext.request.contextPath}"></c:set>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width, user-scalable=no,initial-scale=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script type="text/javascript" src="../jslib/ajaxfileupload.js"></script> 
<script type="text/javascript">
	var editor;
	var flag=0;
	var page=1;
	$(function() {
		var jj=$("#jj").html();
		var jj1=subutil(jj,0,100);
		$("#jj").html(jj1);
		window.setTimeout(function() {
			editor = KindEditor.create('#qqq', {
				width : '100%',
				height : '100%',
				items : [ 'source', '|', 'undo', 'redo', '|', 'preview', 'print', 'template', 'code', 'cut', 'copy', 'paste', 'plainpaste', 'wordpaste', '|', 'justifyleft', 'justifycenter', 'justifyright', 'justifyfull', 'insertorderedlist', 'insertunorderedlist', 'indent', 'outdent', 'subscript', 'superscript', 'clearhtml', 'quickformat', 'selectall', '|', 'fullscreen', '/', 'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline', 'strikethrough', 'lineheight', 'removeformat', '|', 'image', 'flash', 'media', 'insertfile', 'table', 'hr', 'emoticons', 'baidumap', 'pagebreak', 'anchor', 'link', 'unlink' ],
				uploadJson : '${pageContext.request.contextPath}/fileController/upload',
				fileManagerJson : '${pageContext.request.contextPath}/fileController/fileManage',
				allowFileManager : true
			});

			
		}, 1);
		$('#form').form({
			url : '${ctx}/realTimeQAController/add',
			onSubmit : function() {
				editor.sync();
				var isValid = $(this).form('validate');
				if (!isValid) {
					parent.$.messager.progress('close');
				}
				return isValid;
			},
			success : function(result) {
				flag=0;
				result = $.parseJSON(result);
				editor.html("");
				page=1;
				$("#chatlist").html("");
				l_nr();
			}
		});
		l_nr();
	});

	
function fileManage() {
		editor.loadPlugin('filemanager', function() {
			editor.plugin.filemanagerDialog({
				viewType : 'VIEW',
				dirName : 'image',
				clickFn : function(url, title) {
					editor.insertHtml($.formatString('<img src="{0}" alt="" />', url));
					editor.hideDialog();
				}
			});
		});
	}	

function html_encode(str)   
{   
  var s = "";   
  if (str.length == 0) return "";   
  s = str.replace(/&/g, "&gt;");   
  s = s.replace(/</g, "&lt;");   
  s = s.replace(/>/g, "&gt;");   
  s = s.replace(/ /g, "&nbsp;");   
  s = s.replace(/\'/g, "&#39;");   
  s = s.replace(/\"/g, "&quot;");   
  s = s.replace(/\n/g, "<br>");   
  return s;   
}   
 
function html_decode(str)   
{   
  var s = "";   
  if (str.length == 0) return "";   
  // 
  s = str.replace(/&lt;/g, "<");
  s = s.replace(/\/&gt;/g, ">");    
  s = s.replace(/&gt;/g, ">");   
  s = s.replace(/&nbsp;/g, " ");   
  s = s.replace(/&#39;/g, "\'");   
  s = s.replace(/&quot;/g, "\"");   
  s = s.replace(/<br>/g, "\n");   
  s = s.replace(/&gt;/g, "&"); 
  return s;  
}
	
 function subutil(str,start,end){
            if(str=='undefined'||str==''||(typeof(str) == 'undefined'))
                return "";

                ss = str.substr(start, end); // 获取子字符串。

                return ss;               // 返回 "Spain"。
        }
 


 //得到实时问答数据
function l_nr(){
	var username=$("#username").html();
	var url = encodeURI(encodeURI("${ctx}/realTimeQAController/getRealTimeQAList?page="+page+"&rows=10&username="+username));
    $.ajax({
        type:"post",
        dataType:"json",
        url:url,
        beforeSend:function(){
        	
        },
        success:function(data){
        	 
        	  $.each(data, function(index, sc){
        		  if(sc.isOwn=="1"){
        		  	var html="";
        		  	var html2=""; 
        		  	html2=html_decode(sc.content);
        		  	//console.info(html2);
        		  	html+='<div class="c_right" style="width: 800px;height: auto;position: relative;margin-top: 50px;float: right;">';
					html+='<div class="img" style="width: 50px;height: 50px;float: right;">';
					html+='<img src="'+sc.usertx+'" style="width: 100%;height: 100%;">';
					html+='</div>';
					html+='<div class="name" style="width: 100px;float: right;margin-right: 10px;font-size: 12px;color:#A9A9A9; "><span>'+sc.username+'</span></div>';
					html+='<div class="addtime" style="width: 150px;float: right;margin-right: 50px;font-size: 12px;color:#A9A9A9;"><span>'+sc.addtime+'</span></div>';
					html+='<br><div class="chatnr" style="width: 400px;height: auto;word-wrap:break-word;word-break:break-all;float: right;margin-right: 30px;">';
					html+='<span style="width:auto;float:right" id="chat_'+page+index+'"></span>';
					html+='</div>';
					html+='</div>';
					$("#chatlist").prepend(html);
					$("#chat_"+page+""+index).html(html2);
        		  }else{
        		  	var html="";
        		  	var html3="";
        		  	html3=html_decode(sc.content);
        		  	html+='<div class="c_left" style="width: 800px;height: auto;position: relative;margin-top: 50px;">';
					html+='<div class="img" style="width: 50px;height: 50px;">';
					html+='<img src="'+sc.usertx+'" style="width: 100%;height: 100%;">';
					html+='</div>';
					html+='<div class="name" style="width: 100px;margin-left: 70px;margin-top: -50px;font-size: 12px;color:#A9A9A9;"><span>'+sc.username+'</span></div>';
					html+='<div class="addtime" style="width: 150px;margin-left: 170px;margin-top: -20px;font-size: 12px;color:#A9A9A9;"><span>'+sc.addtime+'</span></div>';
					html+='<div class="chatnr" style="width: 400px;margin-left: 66px;height: auto;word-wrap:break-word;word-break:break-all;">';
					html+='<span style="width:400px;" id="chat_'+page+index+'"></span>';
					html+='</div>';
					html+='</div>';
					$("#chatlist").prepend(html);
					$("#chat_"+page+""+index).html(html3);
        		  }
              });
             	
             	var html='<div style="text-align:center;color:#0000CD;width:100%;height:30px;font-size: 12px;margin-top:20px;cursor: pointer;" id="more_'+page+'" onclick="jzmore()">点击加载更多...</div>';
             	$("#chatlist").prepend(html);
 				if(page==1){
 					document.getElementById('cct').scrollTop = document.getElementById('cct').scrollHeight;
 				}
        }
    });
}
 
function jzmore(){
	$("#more_"+page).hide();
	page=page+1;
	l_nr();
}

function ljsx(){
	page=1;
	$("#chatlist").html("");
	l_nr();
}

var iii;
function zdsx(){
	iii=setInterval("ljsx()",5000);
	$("#zdsx").hide();
	$("#qxzdsx").show();
}

function qxzdsx(){
	clearInterval(iii);
	$("#zdsx").show();
	$("#qxzdsx").hide();
}
</script>
<div class="easyui-layout" data-options="fit:true,border:false">
	<div data-options="region:'center',border:false" title="" style="overflow: hidden;">
		<form id="form" method="post">
			<table class="table table-hover table-condensed" style="width: 100%;height: 100%">
				<tr style="height: 400px;width: 820px">
					<td style="width: 820px;">
						<div id="cct" style="width: 820px;height: 400px;overflow: auto;">
						<div id="chatlist" style="width: 800px;">
							
							
						</div>
						</div>
					</td>
					<td style="width: 150px;" rowspan="2">
						<div id="gsinfo" style="height: 100%;width: 100%;text-align: center;background-color: #B0E0E6">
							<br><br>
							<input name="userid" hidden="hidden" value="${sc.id }">
							<div id="username">${sc.companyName }</div><br><br>
							<div style="height: 100px;width: 100px;margin-left: 20px;">
								<img style="height: 100%;width: 100%" src="${sc.companyLogo }">
							</div><br><br>
							<%-- <div style="width: 150px;height: 300px;word-wrap:break-word;word-break:break-all;">
								<span id="jj">
									html_encode(${sc.companyProfile })
								</span>
							</div> --%>
						</div>
					</td>
				</tr>
				<tr style="height: 100px;width: 800px;">
					<td style="width: 500px;">
						<div id="c">
							<textarea name="content" id="qqq"></textarea>
						</div>
					</td>
					
				</tr>
				<tr>
					<td colspan="2" >
						<a id="zdsx" href="javascript:void(0)" class="l-btn" onclick="zdsx();">
							<span class="l-btn-left">
								<span class="l-btn-text">自动刷新(5s)</span>
							</span>
						</a>
						<a id="qxzdsx" href="javascript:void(0)" class="l-btn" onclick="qxzdsx();" style="display: none">
							<span class="l-btn-left">
								<span class="l-btn-text">取消自动刷新</span>
							</span>
						</a>
						<a href="javascript:void(0)" class="l-btn" onclick="ljsx();" style="margin-left: 30px;">
							<span class="l-btn-left">
								<span class="l-btn-text">立即刷新</span>
							</span>
						</a>
						<a href="javascript:void(0)" class="l-btn" onclick="tijiao();" style="margin-left: 500px;">
							<span class="l-btn-left">
								<span class="l-btn-text">发送</span>
							</span>
						</a>
					</td>
				</tr>
			</table>
		</form>
	</div>
</div>
<script type="text/javascript">
var nr="";
function tijiao(){
	var s=editor.html();
	console.info(s);
	if(s.length<1){
		parent.$.messager.alert('提示', "发送的内容为空", 'info');
	}else{
		if(nr==s){
			parent.$.messager.alert('提示', "不能重复发送", 'info');
		}else{
			nr=s;
			$("#form").submit();
		}
	}
}
</script>