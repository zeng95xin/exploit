package com.lcjh.common;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.admin.model.JPushChatModel;
import com.admin.model.LoginUser;
import com.admin.service.JPushApiClient;
import com.admin.service.LoginUserServiceI;
import com.lcjh.biz.Lcjh2Biz;
import com.lcjh.entity.Lcjh2;
import com.lcjh.enummole.LcjhPushEnum;

@Component
public class LcjhJpushUtil {
	
	@Autowired private JPushApiClient jPushApiClient;
	@Autowired private Lcjh2Biz lcjh2Biz;
	@Autowired private LoginUserServiceI loginUserServiceI;
	
	public void pushCareUser(JPushChatModel chat, String userId){
		String sql = "select registrationId from loginuser where id in(select USERID from t_myCare where CONCERNEDID = :userId)";
		Map<String, Object> params = new HashMap<String, Object>(1);
		params.put("userId", userId);
		List<LoginUser> users = lcjh2Biz.findBySqlBuildObject(sql, params, LoginUser.class, null, null);
		List<String> reigsts = new ArrayList<String>(users.size());
		for (LoginUser loginUser2 : users) {
			reigsts.add(loginUser2.getRegistrationId());
		}
		jPushApiClient.jPush_rigstId(reigsts, chat);
	}
	
	public void pushLcjhAllUser(JPushChatModel chat, String lcjhId){
		Lcjh2 l = lcjh2Biz.get(Lcjh2.class, lcjhId);
		if(null == l){
			return;
		}
		String sql = "select registrationId from loginuser where id in(select USERID from t_myCare where CONCERNEDID = :userId)";
		Map<String, Object> params = new HashMap<String, Object>(1);
		params.put("userId", l.getUserId());
		List<LoginUser> users = lcjh2Biz.findBySqlBuildObject(sql, params, LoginUser.class, null, null);
		List<String> reigsts = new ArrayList<String>(users.size() + 1);
		LoginUser user = loginUserServiceI.getUser(l.getUserId());
		if(null != user){
			reigsts.add(user.getRegistrationId());
		}
		for (LoginUser loginUser2 : users) {
			reigsts.add(loginUser2.getRegistrationId());
		}
		jPushApiClient.jPush_rigstId(reigsts, chat);
	}
	
	
	public void pushLcjhOwenUserBuy(String lcjhId, String buyUserId){
		Lcjh2 l = lcjh2Biz.get(Lcjh2.class, lcjhId);
		if(null == l){
			return;
		}
		LoginUser user = loginUserServiceI.getUser(buyUserId);
		if(null == user){
			return;
		}
		JPushChatModel chat = new JPushChatModel();
		String chattitle = "股天乐信息";
		String chatcontent = "你的理财计划'"+l.getJhbt()+"',被用户'" + user.getNickname() + "'购买!";
		chat.setType(LcjhPushEnum.userBuyLcjh.getCode());
		chat.setTitle(chattitle);
		chat.setContent(chatcontent);
		pushUser(chat, l.getUserId());
	}
	
	public void pushUser(JPushChatModel chat, String userId){
		LoginUser user = loginUserServiceI.getUser(userId);
		if(null == user){
			return;
		}
		List<String> reigsts = new ArrayList<String>(1);
		reigsts.add(user.getRegistrationId());
		jPushApiClient.jPush_rigstId(reigsts, chat);
	}
}
