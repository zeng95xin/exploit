package com.web.controller;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.admin.controller.BaseController;
import com.admin.model.Tgsdz;
import com.admin.model.Tgxt;
import com.admin.model.TxwxGl;
import com.admin.service.GqbServiceI;
import com.admin.service.GxtServiceI;
import com.admin.service.XwxServiceI;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.lcjh.result.BooleanObjectResult;
import com.web.exception.CodeEnum;

/**
 * 前台公共管理controller
 * 
 * @author Cyl </br>
 *         (*)必传字段
 */
@Controller
@RequestMapping("/commonMore")
public class CommonMoreController extends BaseController {

	@Autowired
	private XwxServiceI xwxServiceI;
	@Autowired
	private GqbServiceI gqbServiceI;
	@Autowired
	private GxtServiceI gxtServiceI;

	/**
	 * 股天乐接口文档 <br>
	 * <h3>描述:</h3> 根据type跳转不同的控制器
	 * 
	 * @param type
	 * @return
	 */
	@RequestMapping("/getInfoMore")
	@ResponseBody
	public void getInfoMore(HttpServletRequest request, HttpServletResponse response, String wechat, ModelMap modelMap,
			HttpSession session) throws Exception {
		BooleanObjectResult<Object> result = new BooleanObjectResult<Object>(true, CodeEnum.SUCCESS.getCode(),
				CodeEnum.SUCCESS.getMessage());

		String type = request.getParameter("type");
		response.setCharacterEncoding("utf-8");
		if (type.equals("wzlb")) {// 文章列表
			result.setResult(this.newsAPI(request));
			String resStr = "";
			String callback = request.getParameter("callback");
			if (null != callback) {
				resStr += callback + "(";
				resStr += JSONObject.toJSONString(result);
				resStr += ")";
			} else {
				resStr = JSONObject.toJSONString(result);
			}
			request.setCharacterEncoding("utf-8");
			response.setContentType("text/html;charset=utf-8");
			response.getWriter().write(resStr);
			response.getWriter().flush();
		} else if (type.equals("")) {
			result.setResult(null);
			String resStr = "";
			String callback = request.getParameter("callback");
			if (null != callback) {
				resStr += callback + "(";
				resStr += JSONObject.toJSONString(result);
				resStr += ")";
			} else {
				resStr = JSONObject.toJSONString(result);
			}
			request.setCharacterEncoding("utf-8");
			response.setContentType("text/html;charset=utf-8");
			response.getWriter().write(resStr);
			response.getWriter().flush();
		}
	}

	/*
	 * 文章列表
	 */
	private JSONObject newsAPI(HttpServletRequest request) throws Exception {

		String userid = request.getParameter("userid");
		String lanmu = request.getParameter("lanmu");
		String newsId = request.getParameter("newsid");
		String page = request.getParameter("page");
		String rows = request.getParameter("rows");

		JSONObject json = new JSONObject();
		JSONArray arr = new JSONArray();
		// lanmu=8新闻线 7股趣吧 6股学堂
		if (newsId != null) {
			String visitCount = request.getParameter("visitCount");
			if (lanmu.equals("8")) {
				TxwxGl t = new TxwxGl();
				t.setId(newsId);
				t.setVisitCount(visitCount);
				xwxServiceI.saveVisit(t);
			} else if (lanmu.equals("7")) {
				Tgsdz tgsdz = new Tgsdz();
				tgsdz.setId(newsId);
				tgsdz.setVisitCount(visitCount);
				gqbServiceI.saveVisit(tgsdz);
			} else if (lanmu.equals("6")) {
				Tgxt gxtNews = new Tgxt();
				gxtNews.setId(newsId);
				gxtNews.setVisitCount(visitCount);
				gxtServiceI.saveVisit(gxtNews);
			}
			return json;
		}

		if (lanmu.equals("8")) {
			String fl = request.getParameter("fl");// 新闻线分类

			List<TxwxGl> list = xwxServiceI.getList(fl, page, rows);
			int total = xwxServiceI.getCount(fl);
			for (int i = 0; i < list.size(); i++) {
				JSONObject j = new JSONObject();
				TxwxGl t = list.get(i);
				j.put("id", t.getId());
				j.put("xwtitel", t.getXwtitel());
				j.put("xwfbtime", t.getXwfbtime());
				j.put("images", t.getImage());
				arr.add(j);

			}
			return json;
		} else if (lanmu.equals("7")) {// 股趣吧
			String fl = request.getParameter("fl");// 1股市段子 2甘甜股事 3 股道情歌 4趣味小图 5
			if (fl != null) {
				if (fl.equals("1")) {
					fl = "股市段子";
				} else if (fl.equals("2")) {
					fl = "甘甜股事";
				} else if (fl.equals("3")) {
					fl = "股道情歌";
				} else if (fl.equals("4")) {
					fl = "趣味小图";
				} else if (fl.equals("5")) {
					fl = "有趣视频";
				}
			}
			List<Tgsdz> list = gqbServiceI.getList(fl, page, rows);
			for (int i = 0; i < list.size(); i++) {
				JSONObject j = new JSONObject();
				Tgsdz t = list.get(i);
				j.put("id", t.getId());
				j.put("dztitel", t.getDztitel());
				j.put("dzfbtime", t.getDzfbtime());
				j.put("images", t.getImages());
				j.put("http", "http://www.gtl666.com/html/phoneCont.jsp?l=7&id=" + t.getId()
						+ "&u=0338838e-40ae-4e0e-bc8a-e36f35889895");
				arr.add(j);
			}
			json.put("rows", arr);
			return json;

		} else if (lanmu.equals("6")) {// 股学堂
			String fl = request.getParameter("fl");// 分类 1草根教师 2教授讲堂 0憨豆评股
													// 3高手故事、4实战秘籍 5股学吧
			List<Tgxt> list = gxtServiceI.getList(fl, page, rows);
			for (int i = 0; i < list.size(); i++) {
				Tgxt t = list.get(i);
				JSONObject j = new JSONObject();
				j.put("id", t.getId());
				j.put("gxttitel", t.getGxttitel());
				j.put("gxtfbtime", t.getGxtfbtime());
				j.put("images", t.getImage());
				j.put("http", "http://www.gtl666.com/html/phoneCont.jsp?l=6&id=" + t.getId()
						+ "&u=0338838e-40ae-4e0e-bc8a-e36f35889895");
				arr.add(j);
			}
			json.put("rows", arr);
			return json;
		} else {
			return json;
		}
	}

}
