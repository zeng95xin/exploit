<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@page import="java.util.Date" %>
<%@page import="java.text.SimpleDateFormat" %>

<%
   SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
   String value = format.format(new Date());
 %>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<script type="text/javascript">

	var basePath='${pageContext.request.contextPath}';
	$(function() {
		
		window.setTimeout(function() {
				editor = KindEditor.create('#content', {
					width : '700px',
					height : '380px',
					items : [ 'source', '|', 'undo', 'redo', '|', 'preview', 'print', 'template', 'code', 'cut', 'copy', 'paste', 'plainpaste', 'wordpaste', '|', 'justifyleft', 'justifycenter', 'justifyright', 'justifyfull', 'insertorderedlist', 'insertunorderedlist', 'indent', 'outdent', 'subscript', 'superscript', 'clearhtml', 'quickformat', 'selectall', '|', 'fullscreen', '/', 'formatblock', 'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline', 'strikethrough', 'lineheight', 'removeformat', '|', 'image', 'flash', 'media', 'insertfile', 'table', 'hr', 'emoticons', 'baidumap', 'pagebreak', 'anchor', 'link', 'unlink' ],
					uploadJson : '${pageContext.request.contextPath}/fileController/upload',
					fileManagerJson : '${pageContext.request.contextPath}/fileController/fileManage',
					allowFileManager : true
					});
		
					parent.$.messager.progress('close');
			}, 1);
			
		$('#form').form({
			url : '${ctx}/xy/add',
			onSubmit : function() {
				//editor.sync();
				parent.$.messager.progress({
					title : '提示',
					text : '数据处理中，请稍后....'
				});
				var isValid = $(this).form('validate');
				if (!isValid) {
					parent.$.messager.progress('close');
				}
				return isValid;
			},
			success : function(result) {
				parent.$.messager.progress('close');
				console.trace(result);
				//alert(result);
				result = $.parseJSON(result);
				//alert("sssssss"+result);
				if (result.success) {
					
					parent.$.modalDialog.openner_dataGrid.datagrid('reload');//之所以能在这里调用到parent.$.modalDialog.openner_treeGrid这个对象，是因为goodsManagement.jsp页面预定义好了
					parent.$.modalDialog.handler.dialog('close');
				}
			}
		});
		
		
	  $('#db').datebox({
                onShowPanel: function () {//显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
                    span.trigger('click'); //触发click事件弹出月份层
                    if (!tds) setTimeout(function () {//延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
                        tds = p.find('div.calendar-menu-month-inner td');
                        tds.click(function (e) {
                            e.stopPropagation(); //禁止冒泡执行easyui给月份绑定的事件
                            var year = /\d{4}/.exec(span.html())[0]//得到年份
                            , month = parseInt($(this).attr('abbr'), 10); //月份，这里不需要+1
                            $('#db').datebox('hidePanel')//隐藏日期对象
                            .datebox('setValue', year + '-' + month); //设置日期的值
                        });
                    }, 0);
                    yearIpt.unbind();//解绑年份输入框中任何事件
                },
                parser: function (s) {
                    if (!s) return new Date();
                    var arr = s.split('-');
                    return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
                },
                formatter: function (d) { 
                
                var a=d.getMonth()+1;
                var m;
                if(a<10){
                   m='0'+a;
                }else{
                   m=a;
                }
              	 return d.getFullYear() + '-' + m;/*getMonth返回的是0开始的，忘记了。。已修正*/
                }
            });
            var p = $('#db').datebox('panel'), //日期选择对象
                tds = false, //日期选择对象中月份
                yearIpt = p.find('input.calendar-menu-year'),//年份输入框
                span = p.find('span.calendar-text'); //显示月份层的触发控件
            console.log(yearIpt)
            
           
            
      });
		
		
		 function exportExcel(obj){
			var v = $('#db').datebox('getValue'); 
			if(v!=null&&v!=""){
			 var hrefs=basePath+"/scorecount/exportExcel?type=month&time="+v; 
			 obj.href=hrefs; 
			}else{
			  alert("请选择时间段");
			}
			return true;
		}
		
		
	

</script>
<div class="easyui-layout" data-options="fit:true,border:false">
	<div data-options="region:'center',border:false" title=""
		style="overflow: hidden;">
		<form id="form" method="post">
			<table class="table table-hover table-condensed">
				<tr>	
					<th>操作时间:</th>
					<td><input  id="db" type="text" ></td>
				</tr>
				<tr>
					<th>导本年报表</th>
					<td><a href="${pageContext.request.contextPath}/scorecount/exportExcel?type=year" class="easyui-linkbutton" data-options="iconCls:'brick_add',plain:true" >导出EXCEL</a></td>
					<th>导出月明显</th>
					<td><a onclick="exportExcel(this)"  class="easyui-linkbutton" data-options="iconCls:'brick_add',plain:true" id="exportMothExcel" >导出EXCEL(需要选择时间段)</a>
					</td>
				</tr>
				
			</table>
		</form>
	</div>
</div>
