package com.admin.service.impl;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.admin.dao.AdDaoI;
import com.admin.dao.GqbdzDaoI;
import com.admin.dao.GxtDaoI;
import com.admin.dao.LoginUserDaoI;
import com.admin.dao.NewsDaoI;
import com.admin.dao.RoleDaoI;
import com.admin.dao.UserDaoI;
import com.admin.dao.XwxGlDaoI;
import com.admin.model.Ad;
import com.admin.model.LoginUser;
import com.admin.model.News;
import com.admin.model.Tgsdz;
import com.admin.model.Tgxt;
import com.admin.model.Tresource;
import com.admin.model.Trole;
import com.admin.model.Tuser;
import com.admin.model.TxwxGl;
import com.admin.pageModel.DataGrid;
import com.admin.pageModel.PageHelper;
import com.admin.pageModel.SessionInfo;
import com.admin.pageModel.User;
import com.admin.service.AdServiceI;
import com.admin.service.LoginUserServiceI;
import com.admin.service.NewsServiceI;
import com.admin.service.UserServiceI;
import com.admin.util.MD5Util;
import com.web.entity.Person;
import com.web.util.PageModel;
import com.web.util.TimeUtils;

@Service
public class NewsServiceImpl implements NewsServiceI {

	@Autowired
	private NewsDaoI dao;

	@Autowired
	private GxtDaoI gxtDaoI;

	@Autowired
	private XwxGlDaoI xwxGlDaoI;// 新闻线

	@Autowired
	private GqbdzDaoI gqbDao;// 股趣吧

	@Override
	public DataGrid dataGrid(News news, PageHelper ph) {
		DataGrid dg = new DataGrid();
		List<News> ul = new ArrayList<News>();
		Map<String, Object> params = new HashMap<String, Object>();
		String hql = " from News t ";
		List<News> l = dao.find(hql + whereHql(news, params) + orderHql(ph),
				params, ph.getPage(), ph.getRows());
		if (l != null && l.size() > 0) {
			for (News t : l) {
				News u = new News();
				BeanUtils.copyProperties(t, u);
				ul.add(u);
			}
		}
		dg.setRows(ul);
		dg.setTotal(dao.count(
				"select count(*) " + hql + whereHql(news, params), params));
		return dg;
	}

	/**
	 * where条件封装
	 * 
	 * @param ad
	 * @param params
	 * @return
	 */
	private String whereHql(News news, Map<String, Object> params) {
		String hql = "";
		if (news != null) {
			hql += " where status='0' ";
			if (news.getTitle() != null) {
				if (!news.getTitle().equals("")) {
					hql += " and title like:title";
					params.put("title", news.getTitle());
				}
			}

		}
		return hql;
	}

	/**
	 * order封装
	 * 
	 * @param ph
	 * @return
	 */
	private String orderHql(PageHelper ph) {
		String orderString = "";
		if (ph.getSort() != null && ph.getOrder() != null) {
			orderString = " order by t." + ph.getSort() + " " + ph.getOrder();
		}
		return orderString;
	}

	/**
	 * 添加
	 */
	@Override
	public void add(News news) throws Exception {
		news.setId(UUID.randomUUID().toString());
		news.setAddtime(TimeUtils.getTime("yyyy-MM-dd HH:mm:ss"));
		news.setStatus("0");
		dao.save(news);
	}

	/**
	 * 删除
	 */
	@Override
	public void delete(String id) throws Exception {
		News news = dao.get(News.class, id);
		dao.delete(news);
	}

	/**
	 * 编辑
	 */
	@Override
	public void update(News news) throws Exception {
		News n = dao.get(News.class, news.getId());
		n.setTitle(news.getTitle());
		n.setContent(news.getContent());
		dao.update(n);
	}

	/**
	 * 获取对象
	 */
	@Override
	public News get(String id) throws Exception {
		News n = dao.get(News.class, id);
		return n;
	}

	/**
	 * 股学堂
	 */
	@Override
	public void toGxt(News news, String fl) throws Exception {
		Tgxt t = new Tgxt();
		t.setId(news.getId());
		t.setGxttitel(news.getTitle());
		t.setGxtfl(fl);
		t.setGxtnr(news.getContent());
		t.setGxtfl(fl);
		gxtDaoI.save(t);
	}

	/**
	 * 新闻线
	 * 
	 * @param news
	 * @throws Exception
	 */
	@Override
	public void toXwx(News news, String fl) throws Exception {
		TxwxGl t = new TxwxGl();
		t.setId(news.getId());
		t.setXwtitel(news.getTitle());
		t.setXwnr(news.getContent());
		t.setXwfbtime(news.getAddtime());
		t.setXwfbfl(fl);
		xwxGlDaoI.save(t);
	}

	/**
	 * 股趣吧
	 * 
	 * @param news
	 * @throws Exception
	 */
	@Override
	public void toGqb(News news, String fl) throws Exception {
		Tgsdz t = new Tgsdz();
		t.setId(news.getId());
		t.setDztitel(news.getTitle());
		t.setDznr(news.getContent());
		t.setDzfbtime(news.getAddtime());
		t.setQublb(fl);
		gqbDao.save(t);
	}

	/**
	 * 文章转移后修改状态
	 */
	@Override
	public void Zy(String id, String status) throws Exception {
		News n = dao.get(News.class, id);
		n.setStatus(status);
		dao.update(n);
	}

}
