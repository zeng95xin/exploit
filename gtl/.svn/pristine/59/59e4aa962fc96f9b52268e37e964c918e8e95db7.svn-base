var timgid , timgcoder , timgtype;
function share(at){
	this.apiname = ["sina","showapi"]
	this.shareZs = ["http://hq.sinajs.cn/list={code}","http://route.showapi.com/131-45"];
	this.shareGg = ["http://hq.sinajs.cn/list={code}","http://route.showapi.com/131-44"];
	this.searchGg = ["http://route.showapi.com/131-43","http://route.showapi.com/131-43"];
	this.apitype = at;
	this.len = null;
	this.appid = "5816";
	this.secret = "b0c44904cb37437b8b04967c3450a93d";
	this.imgid = null;
	this.imgcoder = null;
	this.imgtype = null;
	this.int = null;
	this.init();
};

share.prototype.init = function(){
	for(var i=0; i<=this.apiname.length; i++){
		if(this.apitype == this.apiname[i]){
			this.len = i;
			break;
		}
	}
	if(this.len == null) alert("接口设置有误，\n目前只支持Sina与Showapi！");
};

share.prototype.keyToContent = function(coder,callback){
	if(this.len == null) return;
	var url = this.searchGg[this.len];
	var date = new Date().Format("yyyyMMddhhmmss");
	var obj = {};
	$.ajax({
        type: 'POST',
        url: this.searchGg[this.len] + "?datatime=" + new Date().getTime(),
        dataType: 'jsonp',
		data: { name: coder, showapi_appid: this.appid, showapi_sign: this.secret, showapi_timestamp: date},
        jsonp: 'jsonpcallback',
		success: function (data) {
            obj.e = data.showapi_res_code;
			obj.msg = data.showapi_res_error;
			obj.cont = data.showapi_res_body.list;
			callback(obj);
        },
        error: function (data) {
			obj.e = "999";
			obj.msg = "http请求错误!";
			obj.cont = "";
			callback(obj);
        }
    });
};

share.prototype.keyToImg = function(coder,type,imgid,imgofswf,width,height){
	if($("#"+imgid).get(0).tagName == "IMG" && imgofswf == "swf"){
		alert("居然想往Img里加Swf！脑子抽了？");
		return;
	}
	this.imgid = imgid;
	this.imgcoder = coder;
	this.imgtype = type;
	timgid = imgid;
	timgcoder = coder;
	timgtype = type;
	
	if(imgofswf == "img"){
		if($("#"+imgid).get(0).tagName == "IMG"){
			$("#"+imgid).attr("src","http://image.sinajs.cn/newchart/"+type+"/n/"+recoder(coder)+".gif");
			if(width) $("#"+imgid).width(width);
			if(height) $("#"+imgid).height(height);
		}else{
			$("#"+imgid).html("<img src='http://image.sinajs.cn/newchart/"+type+"/n/"+recoder(coder)+".gif' id='autoimg' />");
			if(width) $("#autoimg").width(width);
			if(height) $("#autoimg").height(height);
			this.imgid = "autoimg";
			timgid = "autoimg";
		}
	}else{
		var rwidth = (width) ? width:"";
		var rheight = (height) ? height:"";
		$("#"+imgid).html('<embed src="http://finance.sina.com.cn/flash/cn.swf?symbol='+recoder(coder)+'" quality="high" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" wmode="opaque" width="'+rwidth+'" height="'+rheight+'"></embed>');
		//alert($("#"+imgid).html());
	}
	
	if(imgofswf == "img"){
		this.int = setInterval("reloadimg()",5000);
		
	}
};

share.prototype.keyToInflaction = function(coder,callback){
	if(this.len == null) return;
	var url = this.shareGg[this.len];
	var date = new Date().Format("yyyyMMddhhmmss");
	var obj = {};
	if(url.indexOf("{code}") > 0) url = url.replace("{code}",coder);
	if(this.apitype == "sina"){
		$.getScript(url);  
	}else{
		$.ajax({
			type: 'POST',
			url: this.shareGg[this.len] + "?datatime=" + new Date().getTime(),
			dataType: 'jsonp',
			data: { code: coder, showapi_appid: this.appid, showapi_sign: this.secret, showapi_timestamp: date},
			jsonp: 'jsonpcallback',
			success: function (data) {
				obj.e = data.showapi_res_code;
				obj.msg = data.showapi_res_error;
				obj.cont = data.showapi_res_body.stockMarket;
				callback(obj);
			},
			error: function (data) {
				obj.e = "999";
				obj.msg = "http请求错误!";
				obj.cont = "";
				callback(obj);
			}
		});
	}
};

share.prototype.keyToAllInf = function(coder,callback){
	if(this.len == null) return;
	var url = this.shareZs[this.len];
	var date = new Date().Format("yyyyMMddhhmmss");
	var obj = {};
	if(url.indexOf("{code}") > 0) url = url.replace("{code}",coder);
	if(this.apitype == "sina"){
		$.getScript(url);  
	}else{
		$.ajax({
			type: 'POST',
			url: this.shareZs[this.len] + "?datatime=" + new Date().getTime(),
			dataType: 'jsonp',
			data: { code: coder, showapi_appid: this.appid, showapi_sign: this.secret, showapi_timestamp: date},
			jsonp: 'jsonpcallback',
			success: function (data) {
				obj.e = data.showapi_res_code;
				obj.msg = data.showapi_res_error;
				obj.cont = data.showapi_res_body.indexList;
				callback(obj);
			},
			error: function (data) {
				obj.e = "999";
				obj.msg = "http请求错误!";
				obj.cont = "";
				callback(obj);
			}
		});
	}
};

function recoder(co){  
    var endr = co.substr(0,3);
	if(endr == "600" || endr == "601" || endr == "603" || endr == "900"){
		return "sh" + co;	
	}
	if(endr == "000" || endr == "200"){
		return "sz" + co;	
	}
	return co;
}
function reloadimg(){
	$("#"+timgid).attr("src","http://image.sinajs.cn/newchart/"+timgtype+"/n/"+recoder(timgcoder)+".gif?d="+new Date().getTime());
	//console.log("http://image.sinajs.cn/newchart/"+timgtype+"/n/"+recoder(timgcoder)+".gif?d="+new Date().getTime())
}

//================================================
Date.prototype.Format = function (fmt) {
    var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "h+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds(),
        "q+": Math.floor((this.getMonth() + 3) / 3),
        "S": this.getMilliseconds()
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
};