package com.lcjh.task;

import java.util.Date;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.lcjh.biz.Lcjh2Biz;
import com.lcjh.biz.LcjhCjBuySellRecordBiz;
import com.lcjh.biz.LcjhMrzcBiz;
import com.lcjh.common.DayCountUtil;
import com.lcjh.entity.Lcjh2;
import com.lcjh.entity.LcjhCjBuySellRecord;
import com.web.util.DateUtil;

@Component
public class LcjhTask {
	
	@SuppressWarnings("unused")
	@Autowired private LcjhMrzcBiz LcjhMrzcBiz;
	@Autowired private LcjhCjBuySellRecordBiz lcjhCjBuySellRecordBiz;
	@Autowired private Lcjh2Biz lcjh2Biz;
	private final Logger logger = LoggerFactory.getLogger(this.getClass());
	
	public void updateWtwcj(){
		String sql = " select * from t_lcjh_cj_buy_sell_record where `status` = 0 ";
		List<LcjhCjBuySellRecord> list_record = lcjhCjBuySellRecordBiz.findBySqlBuildObject(sql, null, LcjhCjBuySellRecord.class, null, null);
		for (LcjhCjBuySellRecord lcjhCjBuySellRecord : list_record) {
			lcjhCjBuySellRecordBiz.updateWtwcj(lcjhCjBuySellRecord);
		}
	}
	public void updateJs(){
		String sql = "select a.* from t_lcjh2 a where a.`status` = 2 ";
		String sqlCount = "select count(1) from t_lcjh2 a where a.`status` = 2 ";
		int count = lcjh2Biz.countBySql(sqlCount, null);
		
		int start = 1;
		int rows = 300;
		int index = 0;
		List<Lcjh2> list;
		Lcjh2 record;
		Date now = new Date();
		int dayCount = DayCountUtil.getDayCount(now);
		int yestordayCount = dayCount - 1;
		Date syLastDay = DateUtil.getLastDayOfLastMonth(now); // 上个月最后一天
		Date szLastDay = DateUtil.getLastDayOfLastWeek(now);// 上周最后一天
		int szLastDayCount = DayCountUtil.getDayCount(szLastDay);
		int syLastDayCount = DayCountUtil.getDayCount(syLastDay);
		logger.info("lcjh updateJs Start ------------------------");
		do{
			logger.info("lcjh updateJs,第--{}--轮,每轮--{}--条,zsyUpdate, 一共--{}--条", start, rows, count);
			
			list = lcjh2Biz.findBySqlBuildObject(sql, null, Lcjh2.class, start, rows);
			
			for (int i = 0; i < list.size(); i++) {
				record = list.get(i);
				index++;
				logger.info("lcjh updateJs,第--{}--条收益,开始结算", index);
				do{
					try {
						lcjhCjBuySellRecordBiz.updateJs(record, now, dayCount, yestordayCount, szLastDayCount, syLastDayCount);
						logger.info("lcjh updateJs,第--{}--条收益,结算完成", index);
						break;
					} catch (Exception e) {
						logger.error("lcjh updateJs,第--{}--条收益,结算出错,信息:{}", index, e);
						try {
							Thread.sleep(50);
						} catch (InterruptedException e1) {
							logger.error("错误,", e1);
						}
					}
				}while(true);
			}
			start++;
		}while(index < count);
		logger.info("lcjh updateJs end ------------------------");
		
	}
	public void updateJsFjyr(){
		String sql = "select a.* from t_lcjh2 a where a.`status` = 2 ";
		String sqlCount = "select count(1) from t_lcjh2 a where a.`status` = 2 ";
		int count = lcjh2Biz.countBySql(sqlCount, null);
		
		int start = 1;
		int rows = 300;
		int index = 0;
		List<Lcjh2> list;
		Lcjh2 record;
		Date now = new Date();
		int dayCount = DayCountUtil.getDayCount(now);
		int yestordayCount = dayCount - 1;
		logger.info("lcjh updateJsFjyr Start ------------------------");
		do{
			logger.info("lcjh updateJsFjyr,第--{}--轮,每轮--{}--条,zsyUpdate, 一共--{}--条", start, rows, count);
			
			list = lcjh2Biz.findBySqlBuildObject(sql, null, Lcjh2.class, start, rows);
			
			for (int i = 0; i < list.size(); i++) {
				record = list.get(i);
				index++;
				logger.info("lcjh updateJsFjyr,第--{}--条收益,开始结算", index);
				do{
					try {
						lcjhCjBuySellRecordBiz.updateJsFjyr(record, now, dayCount, yestordayCount);
						logger.info("lcjh updateJsFjyr,第--{}--条收益,结算完成", index);
						break;
					} catch (Exception e) {
						logger.error("lcjh updateJsFjyr,第--{}--条收益,结算出错,信息:{}", index, e);
						try {
							Thread.sleep(50);
						} catch (InterruptedException e1) {
							logger.error("错误,", e1);
						}
					}
				}while(true);
			}
			start++;
		}while(index < count);
		
		logger.info("lcjh updateJsFjyr end ------------------------");
	}
	
}
